# ÐšÐ°Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…

## ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± - Ð¾Ð´Ð¸Ð½ ÑÐºÑ€Ð¸Ð¿Ñ‚

ÐŸÐ¾ÑÐ»Ðµ Ñ‚Ð¾Ð³Ð¾, ÐºÐ°Ðº Ð²Ð°Ñˆ Ð¿Ð°Ñ€ÑÐµÑ€ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð» JSON Ñ„Ð°Ð¹Ð», Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ:

```bash
cd /home/project/backend
python3 update_products.py
```

Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚:
- âœ… ÐŸÑ€Ð¾Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ Ð²ÐµÑÑŒ JSON Ñ„Ð°Ð¹Ð»
- âœ… Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¾Ð½ Ð² Ð‘Ð” (Ð¿Ð¾ SKU)
- âœ… Ð•ÑÐ»Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€ **Ð½Ð¾Ð²Ñ‹Ð¹** - Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ ÐµÐ³Ð¾
- âœ… Ð•ÑÐ»Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€ **ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚** - Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ ÐµÐ³Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ðµ
- âœ… Ð˜ÑÐºÐ»ÑŽÑ‡Ð¸Ñ‚ Ð½ÐµÐ½ÑƒÐ¶Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ (raw_html Ð¸ Ñ‚.Ð´.)
- âœ… ÐŸÐ¾ÐºÐ°Ð¶ÐµÑ‚ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ

## Ð¡ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¿ÑƒÑ‚Ñ‘Ð¼ Ðº JSON

```bash
python3 update_products.py /Ð¿ÑƒÑ‚ÑŒ/Ðº/Ð²Ð°ÑˆÐµÐ¼Ñƒ/Ñ„Ð°Ð¹Ð»Ñƒ.json
```

## Ð§Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð²Ð½ÑƒÑ‚Ñ€Ð¸

Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ **UPSERT** (INSERT + UPDATE):
- ÐŸÑ‹Ñ‚Ð°ÐµÑ‚ÑÑ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ
- Ð•ÑÐ»Ð¸ SKU ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ â†’ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ
- Ð•ÑÐ»Ð¸ SKU Ð½Ð¾Ð²Ñ‹Ð¹ â†’ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÑŒ

```sql
INSERT INTO products (...) VALUES (...)
ON CONFLICT (sku) DO UPDATE SET ...
```

## ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ

### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð°

```bash
# Ð’Ð°Ñˆ Ð¿Ð°Ñ€ÑÐµÑ€ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð» JSON
./parser.sh

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð‘Ð”
python3 /home/project/backend/update_products.py
```

### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð² cron (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ)

```bash
# Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ crontab
crontab -e

# Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€Ð¾ÐºÑƒ (Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 3:00)
0 3 * * * cd /home/project/backend && python3 update_products.py
```

### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 3: Ð’Ñ‹Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¸Ð· Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¿Ð°Ñ€ÑÐµÑ€Ð°

```python
import subprocess

# ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ JSON
subprocess.run([
    'python3',
    '/home/project/backend/update_products.py',
    '/path/to/your/products.json'
])
```

## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°

ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²:

```bash
python3 check_database.py
```

Ð˜Ð»Ð¸ Ñ‡ÐµÑ€ÐµÐ· SQL:

```bash
sudo -u postgres psql -d amwine_products -c "SELECT COUNT(*) FROM products;"
```

## Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ (Ð±ÐµÐ· Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ…)

Ð•ÑÐ»Ð¸ Ð²Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¢ÐžÐ›Ð¬ÐšÐž Ð½Ð¾Ð²Ñ‹Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹, Ð½Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ:

```sql
-- Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð² update_products.py ÑÑ‚Ñ€Ð¾ÐºÑƒ ON CONFLICT Ð½Ð°:
ON CONFLICT (sku) DO NOTHING
```

## Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²

Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÐµÑ‚ Ð² Ð½Ð¾Ð²Ð¾Ð¼ JSON:

```python
# Ð’ update_products.py Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð² ÐºÐ¾Ð½ÐµÑ† Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ update_products():

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ SKU Ð¸Ð· JSON
json_skus = set(p['sku'] for p in products)

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÐµÑ‚ Ð² JSON
cursor.execute(
    "DELETE FROM products WHERE sku NOT IN %s",
    (tuple(json_skus),)
)
print(f"Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²: {cursor.rowcount}")
```

## Ð§Ð°ÑÑ‚Ð¸Ñ‡Ð½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ†ÐµÐ½Ñ‹)

Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ†ÐµÐ½Ñ‹:

```bash
cd /home/project/backend
```

Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ `update_prices.py`:

```python
import json
import psycopg2
from db_config import DB_CONFIG

with open('/home/testuser/amwine_products.json') as f:
    products = json.load(f)

conn = psycopg2.connect(**DB_CONFIG)
cursor = conn.cursor()

for product in products:
    cursor.execute(
        "UPDATE products SET price_current = %s, updated_at = CURRENT_TIMESTAMP WHERE sku = %s",
        (product['price_current'], product['sku'])
    )

conn.commit()
cursor.close()
conn.close()
```

## ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ

```bash
# 1. ÐŸÐ°Ñ€ÑÐµÑ€ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð» JSON (Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» 100 Ð½Ð¾Ð²Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²)
$ ./your_parser.sh
# Saved 2500 products to amwine_products.json

# 2. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð‘Ð”
$ python3 update_products.py
Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· /home/testuser/amwine_products.json...
ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ 2500 Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² JSON Ñ„Ð°Ð¹Ð»Ðµ
Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²...
ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ 100/2500 Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²...
ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ 200/2500 Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²...
...
============================================================
ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!
ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²: 2500
ÐžÑˆÐ¸Ð±Ð¾Ðº: 0
============================================================

# 3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼
$ python3 check_database.py
Total products: 2500  âœ…
```

## Ð¡Ð¾Ð²ÐµÑ‚Ñ‹

1. **Ð”ÐµÐ»Ð°Ð¹Ñ‚Ðµ Ð±ÑÐºÐ°Ð¿Ñ‹** Ð¿ÐµÑ€ÐµÐ´ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð¼Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÑÐ¼Ð¸:
   ```bash
   pg_dump -U postgres amwine_products > backup_$(date +%Y%m%d).sql
   ```

2. **Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð½Ð° ÐºÐ¾Ð¿Ð¸Ð¸ Ð‘Ð”** Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹

3. **Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ** Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸:
   ```python
   # Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð² update_products.py
   import logging
   logging.basicConfig(filename='update.log', level=logging.INFO)
   ```

4. **ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐ¹Ñ‚Ðµ JSON** Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¾Ð¹:
   ```bash
   python3 -m json.tool amwine_products.json > /dev/null && echo "JSON Ð²Ð°Ð»Ð¸Ð´ÐµÐ½"
   ```

Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð‘Ð” Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð¾Ð´Ð½Ñƒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ ðŸš€
