# Отчет по оптимизации рекомендательной системы

## Дата: 2025-12-16

## 1. Аналитика данных

### Статистика по товарам:
- **Всего товаров**: 9,117
- **В наличии**: 9,115 (99.98%)
- **С рейтингами**: 2,456 (27%)

### Распределение по категориям:
- Вино: 5,020 (55%)
- Коньяк: 828 (9%)
- Игристые вина: 584 (6%)
- Водка: 340 (4%)
- Пиво: 293 (3%)

### Распределение по цветам (вина):
- Красное: 2,915 (48%)
- Белое: 2,583 (42%)
- Розовое: 477 (8%)

### Ценовые диапазоны:
- 0-500₽: 1,451 (16%)
- 500-1,000₽: 2,145 (24%)
- 1,000-2,000₽: 2,093 (23%)
- 2,000-5,000₽: 1,548 (17%)
- 5,000+₽: 912 (10%)

### Крепость (ABV):
- Минимум: 0.05%
- Максимум: 85%
- Среднее: 19.8%

### Дополнительные атрибуты:
- Сорт винограда: 4,198 товаров (46%)
- Выдержка: 1,247 товаров (14%)
- Содержание сахара: 6,001 товаров (66%)

## 2. Оптимизации алгоритма персонализации

### 2.1 Улучшенная система весов

**Старая система:**
- Цена: 30%
- ABV: 20%
- Категория: 30%
- Рейтинг: 10%
- Доступность: 10%

**Новая система:**
- Цена: 25% (↓5%) - оптимизация для более гибкого подбора
- ABV: 20% (без изменений)
- Категория: 25% (↓5%) - баланс между категорией и рейтингом
- Рейтинг: 15% (↑5%) - больше внимания к проверенным товарам
- Доступность: 10% (без изменений)
- **Популярность: 5% (НОВОЕ)** - логарифмический буст для популярных товаров

### 2.2 Улучшения алгоритма скоринга

1. **Цена**: Теперь предпочитает товары на 20% дешевле середины бюджета (лучшее соотношение цена/качество)

2. **ABV**: Увеличена толерантность с 5% до 7% для более гибкого подбора

3. **Рейтинг с confidence boost**:
   - Товары с большим количеством отзывов получают бонус до 20%
   - Новые товары без рейтингов получают средний балл (40%)
   - Использует Wilson score для уверенности в рейтинге

4. **Популярность (НОВАЯ)**:
   - Логарифмическая шкала: log(reviews + 1) / log(100)
   - Предотвращает доминирование самых популярных товаров
   - Дает преимущество товарам с 10-50 отзывами

### 2.3 Улучшенный алгоритм разнообразия

**Старый алгоритм:**
- Простая фильтрация по уникальным комбинациям производитель+страна
- Fetches limit * 2 товаров

**Новый алгоритм:**
- Fetches limit * 3 товаров для лучшего выбора
- Учитывает 3 измерения разнообразия:
  - Производитель (штраф 15% за повтор)
  - Страна (штраф 10% за повтор)
  - Ценовой диапазон (штраф 5% за повтор)
- Жадный алгоритм с динамической корректировкой баллов
- Гарантирует хорошее распределение по всем измерениям

### 2.4 Оптимизация SQL запросов

**Старый ORDER BY:**
```sql
ORDER BY
    COALESCE(rating_value, 0) DESC,
    rating_count DESC NULLS LAST,
    price_current ASC
```

**Новый ORDER BY:**
```sql
ORDER BY
    (COALESCE(rating_value, 3.5) * COALESCE(NULLIF(rating_count, 0), 1)) DESC,
    price_current ASC
```

Преимущества:
- Использует popularity score (rating × count) для первичной сортировки
- Товары без рейтинга получают значение 3.5 (средний балл)
- Лучше балансирует между качеством и популярностью
- Fetches limit * 5 вместо limit * 3 для re-ranking

## 3. Новые функции

### 3.1 get_similar_products(sku, limit=6)

Рекомендации "похожих товаров" на основе:
- Сорт винограда (вес 3)
- Цвет (вес 2)
- Страна (вес 2)
- Содержание сахара (вес 1)
- Производитель (вес 1)
- Близость по цене (±500₽, вес 1)

**Использование:**
```python
recommender = ProductRecommender()
similar = recommender.get_similar_products(sku="51240322", limit=6)
```

### 3.2 get_trending_products(drink_type=None, limit=10)

Популярные/трендовые товары на основе:
- Trending score = rating × log(review_count + 10)
- Фильтрация по типу напитка (опционально)
- Только товары с отзывами

**Использование:**
```python
recommender = ProductRecommender()
trending = recommender.get_trending_products(drink_type=DrinkType.WINE_RED, limit=10)
```

## 4. Оптимизация базы данных

### 4.1 Новые индексы (8 штук)

1. **idx_products_rating_composite**
   - Поля: rating_value DESC, rating_count DESC
   - Цель: Ускорение запросов trending products
   - Partial index: только in_stock товары с rating_count > 0

2. **idx_products_attrs_color**
   - Поле: attrs_json->>'Цвет'
   - Цель: Быстрая фильтрация по цвету вина
   - Partial index: только in_stock товары

3. **idx_products_attrs_grape**
   - Поле: attrs_json->>'Сорт винограда'
   - Цель: Быстрый поиск по сорту винограда для similarity
   - Partial index: только in_stock товары

4. **idx_products_attrs_sugar**
   - Поле: attrs_json->>'Содержание сахара'
   - Цель: Фильтрация по содержанию сахара

5. **idx_products_abv_availability**
   - Поля: abv_percent, availability_status
   - Цель: Ускорение фильтрации по крепости

6. **idx_products_price_availability**
   - Поля: price_current, availability_status
   - Цель: Быстрые ценовые запросы
   - Partial index: только in_stock товары

7. **idx_products_country_producer**
   - Поля: country, producer
   - Цель: Similarity searches и diversity filtering
   - Partial index: только in_stock товары

8. **idx_products_category_lower**
   - Поле: LOWER(category_path)
   - Цель: Case-insensitive поиск по категориям
   - Partial index: только in_stock товары

### 4.2 Результаты оптимизации

- Все индексы успешно созданы
- Статистика таблиц обновлена (ANALYZE)
- Ожидаемое ускорение запросов: **2-5x** для фильтраций по JSONB полям
- Ожидаемое ускорение для trending queries: **3-10x**

## 5. Ожидаемые улучшения

### Качество рекомендаций:
- ✅ Лучший баланс между новыми и популярными товарами
- ✅ Более разнообразные рекомендации
- ✅ Учет популярности без доминирования "хитов"
- ✅ Более гибкий подбор по крепости (±7% вместо ±5%)
- ✅ Предпочтение товаров с хорошим соотношением цена/качество

### Производительность:
- ✅ Ускорение JSONB запросов в 2-5 раз
- ✅ Ускорение trending запросов в 3-10 раз
- ✅ Более эффективная сортировка по popularity score
- ✅ Оптимизированные partial indexes для in_stock товаров

### Новые возможности:
- ✅ Similar products для "Вам также может понравиться"
- ✅ Trending products для главной страницы
- ✅ Улучшенный diversity алгоритм

## 6. Следующие шаги (опционально)

Потенциальные дальнейшие улучшения:

1. **Collaborative Filtering**:
   - Построение user-item матрицы
   - ALS или Matrix Factorization
   - Требует данные о пользовательских предпочтениях

2. **Content-based filtering с NLP**:
   - TF-IDF на texts_json (описание, вкус, аромат)
   - Semantic similarity с embeddings
   - Требует дополнительная обработка текстов

3. **A/B тестирование**:
   - Сравнение старой и новой систем
   - Метрики: CTR, conversion rate, diversity

4. **Кэширование**:
   - Redis для популярных запросов
   - Кэш trending products (обновление раз в час)

5. **Machine Learning модели**:
   - Learning-to-Rank (LambdaMART, XGBoost)
   - Требует labeled данные (клики, покупки)

## 7. Как использовать

### Обновление БД:
```bash
cd /home/project/backend
python3 update_products.py /home/testuser/amwine_products.json
```

### Оптимизация индексов:
```bash
python3 optimize_db.py
```

### Тестирование API:
```bash
# Запустить API сервер
cd /home/project/backend/api
uvicorn main:app --reload

# Тестировать рекомендации
curl -X POST http://localhost:8000/recommendations \
  -H "Content-Type: application/json" \
  -d '{"drink_type": "wine_red", "occasion": "dinner", "style": "moderate", "budget": "medium"}'
```

## 8. Заключение

Рекомендательная система успешно оптимизирована:
- ✅ 9,117 товаров загружены в БД
- ✅ Улучшен алгоритм scoring с учетом популярности
- ✅ Добавлен интеллектуальный diversity алгоритм
- ✅ Созданы 8 новых индексов для ускорения запросов
- ✅ Добавлены новые функции: similar_products, trending_products
- ✅ Оптимизированы SQL запросы

Система готова к использованию и предоставляет более качественные и разнообразные рекомендации.
